<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Berhitung</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
         :root {
            --bg-color: #fdf0d5;
            --primary-color: #f08080; /* Tema Hitung */
            --primary-hover: #e57373;
            --secondary-color: #66d9ef; /* Warna Opsi */
            --secondary-hover: #4fc3f7;
            --text-color: #333;
            --white-color: #fff;
            --correct-color: #81c784;
            --wrong-color: #e57373;
            --border-radius: 15px;
            --home-btn-bg: #ffcc80;
            --home-btn-hover: #ffb74d;
            --copyright-color: rgba(51, 51, 51, 0.7);
            --score-color: #555; /* Warna Teks Skor */
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 70px 20px 40px 20px; /* Padding atas untuk Home, bawah untuk copyright */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; /* Untuk copyright & home */
        }

        /* --- PERUBAHAN: Home Button diperbesar ~30% --- */
        .home-btn {
            position: absolute; top: 15px; left: 15px;
            background-color: var(--home-btn-bg); color: var(--text-color);
             /* Naikkan padding & font-size */
            padding: 13px 20px; /* Dari 10px 15px */
            font-size: clamp(1.1rem, 4vw, 1.5rem); /* Dari 0.9rem, 3vw, 1.2rem */
            border: none; border-radius: var(--border-radius); cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: inline-flex; align-items: center; gap: 10px; /* Perbesar gap sedikit */
            z-index: 10;
        }
        .home-btn:hover { background-color: var(--home-btn-hover); transform: scale(1.05); }
        .home-btn:active { transform: scale(0.98); }
        .home-btn i { font-size: 1.1em; } /* Perbesar ikon sedikit */

        h1 {
            font-size: clamp(2rem, 8vw, 3.5rem); color: var(--primary-color);
            margin-bottom: 1em; text-align: center;
        }

        #menu-pilihan {
             display: flex; flex-direction: column; gap: 20px;
             width: 90%; max-width: 500px; margin-bottom: 30px;
        }
        .button-pilihan {
            padding: 20px 30px; font-size: clamp(1.5rem, 5vw, 2.5rem);
            background-color: var(--primary-color); color: var(--white-color);
            border: none; border-radius: var(--border-radius); cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            width: 100%; display: flex; align-items: center;
            justify-content: center; gap: 10px;
        }
        .button-pilihan:hover { background-color: var(--primary-hover); transform: scale(1.03); }
        .button-pilihan:active { transform: scale(0.98); }

         #kuis-container {
            display: none; width: 100%; max-width: 600px;
            text-align: center; padding-bottom: 50px;
        }

         #progress-container {
            width: 80%; max-width: 400px; height: 20px;
            background-color: #e0e0e0; border-radius: 10px;
            margin: 0 auto 5px auto; /* Kurangi margin bawah sedikit */
            overflow: hidden;
        }
        #progress-bar {
            width: 0%; height: 100%; background-color: var(--primary-color);
            border-radius: 10px; transition: width 0.5s ease;
        }
         #level-info {
             font-size: clamp(1rem, 3.5vw, 1.3rem); margin-top: 5px;
             margin-bottom: 10px; /* Kurangi margin bawah */
             color: var(--text-color);
         }

         /* --- BARU: Score Info Style --- */
         #score-info {
             font-size: clamp(1.1rem, 4vw, 1.4rem); margin-bottom: 20px;
             color: var(--score-color); font-weight: bold;
         }

        #soal {
            font-size: clamp(2.5rem, 10vw, 4rem); margin-bottom: 30px;
            font-weight: bold; color: var(--primary-color); min-height: 1.5em;
        }

        #opsiJawaban {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            width: 90%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
        }

        .opsi {
            padding: 20px 15px;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            background-color: var(--secondary-color);
            color: var(--white-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .opsi:hover {
            background-color: var(--secondary-hover);
            transform: scale(1.03);
        }
        .opsi:active {
            transform: scale(0.98);
        }
        .opsi:disabled { /* Style saat opsi dinonaktifkan */
             opacity: 0.6;
             cursor: not-allowed;
        }


        #notifikasi-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        #notifikasi {
            font-size: clamp(2.5rem, 10vw, 5rem); padding: 30px 50px;
            border-radius: var(--border-radius); color: var(--white-color);
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            transform: scale(0.5); opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            text-align: center; /* Pastikan teks notif center */
        }
         #notifikasi i { font-size: 1.2em; }
         /* --- PERUBAHAN: Tambah class 'coba-lagi' --- */
        .benar { background-color: var(--correct-color); }
        .salah { background-color: var(--wrong-color); }
        .coba-lagi { background-color: var(--wrong-color); } /* Sama dg salah, tp icon beda */
        #notifikasi-overlay.show #notifikasi { transform: scale(1); opacity: 1; }

        /* --- BARU: Final Score Overlay Style --- */
        #final-score-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Sedikit lebih gelap */
            display: none; /* Awalnya hidden */
            flex-direction: column; /* Konten tumpuk vertikal */
            justify-content: center; align-items: center; z-index: 1001; /* Di atas notif biasa */
            color: var(--white-color); text-align: center; padding: 20px;
        }
        #final-score-content {
             background-color: var(--correct-color); /* Latar hijau cerah */
             padding: clamp(30px, 8vw, 60px);
             border-radius: var(--border-radius);
             box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
         #final-score-content h2 {
            font-size: clamp(2rem, 8vw, 3.5rem); margin-bottom: 15px;
            color: var(--white-color);
        }
        #final-score-content p {
            font-size: clamp(1.2rem, 5vw, 1.8rem); margin-bottom: 30px;
            color: var(--white-color);
        }
        #final-score-content .home-btn-final { /* Style tombol home di final score */
            padding: 15px 25px;
            font-size: clamp(1.2rem, 4.5vw, 1.8rem);
            background-color: var(--home-btn-bg);
            color: var(--text-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: inline-flex; align-items: center; gap: 10px;
        }
        #final-score-content .home-btn-final:hover {
            background-color: var(--home-btn-hover);
            transform: scale(1.05);
        }
         #final-score-content .home-btn-final:active {
             transform: scale(0.98);
         }
         #final-score-content .home-btn-final i {
             font-size: 1.1em;
         }


        /* --- BARU: Copyright Style --- */
        .copyright {
            position: absolute; bottom: 10px; right: 10px;
            font-size: clamp(0.7rem, 2vw, 0.8rem);
            color: var(--copyright-color); z-index: 5;
        }
    </style>
</head>
<body>
    <!-- BARU: Tambahkan onclick untuk suara -->
    <button class="home-btn" onclick="playSound('click-sound'); location.href='index.html'"><i class="fas fa-home"></i> Home</button>

    <h1>Pilih Berhitung</h1>

    <div id="menu-pilihan">
         <!-- BARU: Tambahkan onclick untuk suara -->
        <button class="button-pilihan" onclick="playSound('click-sound'); mulaiLevel('penjumlahan')"><i class="fas fa-plus"></i> Penjumlahan</button>
         <!-- BARU: Tambahkan onclick untuk suara -->
        <button class="button-pilihan" onclick="playSound('click-sound'); mulaiLevel('pengurangan')"><i class="fas fa-minus"></i> Pengurangan</button>
    </div>

    <div id="kuis-container">
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="level-info"></div>
        <!-- --- BARU: Score Info Element --- -->
        <div id="score-info">Benar: 0 | Salah: 0</div>
        <div id="soal"></div>
        <div id="opsiJawaban">
            <!-- Tombol opsi akan dibuat oleh JavaScript -->
        </div>
     </div>

    <div id="notifikasi-overlay">
        <div id="notifikasi">
            <i class=""></i>
            <span id="notifikasi-teks"></span>
        </div>
    </div>

    <!-- --- BARU: Final Score Overlay Element --- -->
    <div id="final-score-overlay">
        <div id="final-score-content">
            <h2>Selamat! 🎉</h2>
            <p id="final-score-text">Kamu menyelesaikan semua level!</p>
            <p id="final-score-detail">Skor Akhir: Benar: 0 | Salah: 0</p>
            <!-- BARU: Tombol Home di Final Score -->
            <button class="home-btn-final" onclick="playSound('click-sound'); location.href='index.html'">
                <i class="fas fa-home"></i> Kembali ke Home
            </button>
        </div>
    </div>

    <!-- --- BARU: Copyright Element --- -->
    <div class="copyright">Copyright Mas Har - B.3.9</div>

    <!-- --- BARU: Audio Elements --- -->
    <audio id="click-sound" src="ping.wav" preload="auto"></audio>
    <audio id="wrong-sound" src="gameovertwew.wav" preload="auto"></audio>

    <script>
        let jawabanBenar, currentLevel = 0, currentSoal = 0, jenisSoal;
        const soalPerLevel = 10;
        const totalLevel = 5;

        // --- BARU: Score Variables ---
        let scoreBenar = 0;
        let scoreSalah = 0;

        const levels = { // (Data levels tidak berubah, tetap sama)
            penjumlahan: [
                Array(soalPerLevel).fill().map(() => ({ a: Math.floor(Math.random() * 5) + 1, b: Math.floor(Math.random() * 5) + 1 })),
                Array(soalPerLevel).fill().map(() => ({ a: Math.floor(Math.random() * 10) + 1, b: Math.floor(Math.random() * 10) + 1 })),
                Array(soalPerLevel).fill().map(() => ({ a: Math.floor(Math.random() * 11) + 5, b: Math.floor(Math.random() * 11) + 5 })),
                Array(soalPerLevel).fill().map(() => ({ a: Math.floor(Math.random() * 16) + 10, b: Math.floor(Math.random() * 16) + 10 })),
                Array(soalPerLevel).fill().map(() => ({ a: Math.floor(Math.random() * 31) + 20, b: Math.floor(Math.random() * 31) + 20 }))
            ],
            pengurangan: [
                Array(soalPerLevel).fill().map(() => { let a = Math.floor(Math.random() * 9) + 2; let b = Math.floor(Math.random() * (a - 1)) + 1; return { a, b }; }),
                Array(soalPerLevel).fill().map(() => { let a = Math.floor(Math.random() * 16) + 5; let b = Math.floor(Math.random() * (a - 2)) + 1; return { a, b }; }),
                Array(soalPerLevel).fill().map(() => { let a = Math.floor(Math.random() * 21) + 10; let b = Math.floor(Math.random() * (a - 3)) + 1; return { a, b }; }),
                Array(soalPerLevel).fill().map(() => { let a = Math.floor(Math.random() * 31) + 20; let b = Math.floor(Math.random() * (a - 5)) + 1; return { a, b }; }),
                Array(soalPerLevel).fill().map(() => { let a = Math.floor(Math.random() * 41) + 30; let b = Math.floor(Math.random() * (a - 10)) + 1; return { a, b }; })
            ]
        };

        const menuPilihanElem = document.getElementById('menu-pilihan');
        const kuisContainerElem = document.getElementById('kuis-container');
        const judulElem = document.querySelector('h1');
        const soalElem = document.getElementById('soal');
        const opsiJawabanContainer = document.getElementById('opsiJawaban');
        const scoreInfoElem = document.getElementById('score-info'); // BARU: Referensi skor
        const finalScoreOverlay = document.getElementById('final-score-overlay'); // BARU: Referensi Final Score

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function generateOptions(correctAnswer) {
             let options = [correctAnswer];
            const maxAttempts = 10;
            let attempts = 0;
            while (options.length < 4 && attempts < maxAttempts) {
                let wrongOption;
                let variation = Math.floor(Math.random() * 10) + 1;
                if (Math.random() < 0.5) {
                    wrongOption = correctAnswer + variation;
                } else {
                    wrongOption = correctAnswer - variation;
                    if (wrongOption < 0) wrongOption = correctAnswer + variation + 1; // Hindari negatif jika bisa
                }
                 if (wrongOption >= 0 && !options.includes(wrongOption)) {
                    options.push(wrongOption);
                }
                attempts++;
            }
             while (options.length < 4) {
                 let randomNum = Math.max(0, correctAnswer + (Math.floor(Math.random()*21)-10));
                 if(!options.includes(randomNum)){
                     options.push(randomNum)
                 } else {
                      options.push(Math.max(0, Math.floor(Math.random()*50)+correctAnswer-25)) // Fallback lebih terarah
                 }
             }
            shuffleArray(options);
            return options;
        }

        // --- PERUBAHAN: Reset Skor saat mulai ---
        function mulaiLevel(jenis) {
            jenisSoal = jenis;
            currentLevel = 0;
            currentSoal = 0;
            scoreBenar = 0; // Reset skor
            scoreSalah = 0; // Reset skor
            updateScoreDisplay(); // Tampilkan skor awal (0)
            finalScoreOverlay.style.display = 'none'; // Sembunyikan final score jika kembali
            menuPilihanElem.style.display = 'none';
            kuisContainerElem.style.display = 'block';
            judulElem.textContent = jenis === 'penjumlahan' ? 'Penjumlahan' : 'Pengurangan';
            tampilkanSoal();
        }

        function tampilkanSoal() {
            // Cek jika level SELESAI sebelum menampilkan soal berikutnya
            if (currentSoal >= soalPerLevel) {
                currentLevel++;
                currentSoal = 0;
                // Cek apakah SEMUA level sudah selesai
                if (currentLevel >= totalLevel) {
                    tampilkanFinalScore(); // Tampilkan layar skor akhir
                    return; // Stop proses tampilkan soal
                } else {
                    // Lanjut ke level berikutnya
                    tampilkanNotifikasi(`Level ${currentLevel + 1} Mulai!`, 'lanjut', true); // Notif pindah level
                    // Tidak perlu timeout di sini, notifikasi akan hilang saat soal baru tampil atau dihandle oleh setTimeout di cekJawaban
                }
            }

             // Jika belum selesai semua level, tampilkan soal
            let soal = levels[jenisSoal][currentLevel][currentSoal];
            jawabanBenar = jenisSoal === 'penjumlahan' ? soal.a + soal.b : soal.a - soal.b;
            soalElem.innerHTML = `${soal.a} ${jenisSoal === 'penjumlahan' ? '+' : '−'} ${soal.b} = ?`;

            let opsiAcak = generateOptions(jawabanBenar);
            opsiJawabanContainer.innerHTML = '';
            opsiAcak.forEach(opsi => {
                const button = document.createElement('button');
                button.classList.add('opsi');
                button.textContent = opsi;
                 // BARU: Tambahkan playSound('click-sound') saat tombol opsi diklik, SEBELUM cekJawaban
                button.onclick = () => { playSound('click-sound'); cekJawaban(opsi); };
                opsiJawabanContainer.appendChild(button);
            });

            updateProgressBar();
            disableOptions(false); // Aktifkan opsi untuk soal baru
        }

        function disableOptions(disabled) {
             const buttons = opsiJawabanContainer.querySelectorAll('.opsi');
             buttons.forEach(button => {
                 button.disabled = disabled;
             });
         }

        // --- PERUBAHAN BESAR: Logic Cek Jawaban (Retry on Wrong) ---
        function cekJawaban(pilihan) {
            disableOptions(true); // Nonaktifkan opsi sementara

            if (parseInt(pilihan) === jawabanBenar) {
                // Jawaban Benar
                scoreBenar++;
                updateScoreDisplay();
                // Suara benar (pakai click sound saja sesuai request awal)
                // playSound('click-sound'); // Sudah di onclick tombol
                tampilkanNotifikasi('Benar!', 'benar', true); // Tampilkan notif benar

                // Tunggu sebentar, lalu lanjut soal berikutnya
                setTimeout(() => {
                    sembunyikanNotifikasi();
                    currentSoal++; // Maju ke soal berikutnya
                    tampilkanSoal(); // Tampilkan soal baru (atau cek level selesai)
                }, 1200); // Durasi notifikasi benar sedikit lebih cepat

            } else {
                // Jawaban Salah
                scoreSalah++;
                updateScoreDisplay();
                playSound('wrong-sound'); // Mainkan suara salah
                tampilkanNotifikasi('Salah! Coba lagi ya!', 'coba-lagi', false); // Notif coba lagi (jangan auto hide)

                // Tunggu sebentar, lalu sembunyikan notif dan aktifkan lagi opsi
                setTimeout(() => {
                    sembunyikanNotifikasi();
                    disableOptions(false); // Aktifkan kembali opsi untuk mencoba lagi
                }, 1500); // Durasi notifikasi salah
                // JANGAN MAJUKAN currentSoal agar soal yang sama ditampilkan lagi
            }
        }

        // --- BARU: Update Score Display ---
        function updateScoreDisplay() {
            scoreInfoElem.textContent = `Benar: ${scoreBenar} | Salah: ${scoreSalah}`;
        }

        // --- PERUBAHAN: Modifikasi Tampilkan Notifikasi untuk Coba Lagi ---
        function tampilkanNotifikasi(pesan, tipe, autoHide) { // autoHide tidak dipakai di logic baru
            const overlay = document.getElementById('notifikasi-overlay');
            const notifikasi = document.getElementById('notifikasi');
            const notifikasiTeks = document.getElementById('notifikasi-teks');
            const ikon = notifikasi.querySelector('i');

            notifikasiTeks.textContent = pesan;
            notifikasi.className = ''; ikon.className = ''; // Reset class

            if (tipe === 'benar') {
                 notifikasi.classList.add('benar'); ikon.classList.add('fas', 'fa-check-circle');
            } else if (tipe === 'salah') { // Tipe 'salah' tidak dipakai lagi untuk jawaban, diganti 'coba-lagi'
                 notifikasi.classList.add('salah'); ikon.classList.add('fas', 'fa-times-circle');
            } else if (tipe === 'coba-lagi') { // BARU
                 notifikasi.classList.add('coba-lagi'); ikon.classList.add('fas', 'fa-redo'); // Icon refresh/coba lagi
            } else if (tipe === 'lanjut') {
                 notifikasi.classList.add('benar'); ikon.classList.add('fas', 'fa-arrow-circle-right');
            }
             // Hapus logika 'selesai' dari sini, ditangani final score

            overlay.style.display = 'flex';
            setTimeout(() => { overlay.classList.add('show'); }, 10);

            // Hapus auto hide, akan di-handle manual oleh setTimeout di cekJawaban
        }

        function sembunyikanNotifikasi() {
            const overlay = document.getElementById('notifikasi-overlay');
            overlay.classList.remove('show');
             setTimeout(() => { overlay.style.display = 'none'; }, 300); // Delay agar transisi selesai
        }

        function updateProgressBar() {
             const progressBar = document.getElementById('progress-bar');
            const levelInfo = document.getElementById('level-info');
            const totalSoalInLevel = soalPerLevel;
            // Penyesuaian agar progress bar tidak aneh saat soal terakhir level
            const soalEfektif = currentSoal >= totalSoalInLevel ? totalSoalInLevel : currentSoal;
            const progress = (soalEfektif / totalSoalInLevel) * 100;
            progressBar.style.width = `${progress}%`;
            // Penyesuaian nomor soal tampil
             const nomorSoalTampil = currentSoal >= totalSoalInLevel ? totalSoalInLevel : currentSoal + 1;
             levelInfo.textContent = `Level ${currentLevel + 1} - Soal ${nomorSoalTampil}/${totalSoalInLevel}`;
        }

        // --- BARU: Fungsi Play Sound (Sama seperti index.html) ---
        function playSound(soundId) {
            try {
                const sound = document.getElementById(soundId);
                if (sound) {
                    sound.currentTime = 0;
                    sound.play();
                } else {
                    console.warn("Audio element not found:", soundId);
                }
            } catch (error) {
                console.error("Error playing sound:", error);
            }
        }

        // --- BARU: Fungsi Tampilkan Final Score ---
        function tampilkanFinalScore() {
            kuisContainerElem.style.display = 'none'; // Sembunyikan kuis
            sembunyikanNotifikasi(); // Pastikan notif biasa hilang

            // Update teks di overlay final score
            document.getElementById('final-score-text').textContent = `Kamu menyelesaikan semua ${totalLevel} level ${jenisSoal}!`;
            document.getElementById('final-score-detail').textContent = `Skor Akhir: Benar: ${scoreBenar} | Salah: ${scoreSalah}`;

            // Tampilkan overlay final score
            finalScoreOverlay.style.display = 'flex';
            // Optional: Mainkan suara kemenangan?
            // playSound('victory-sound'); // Jika ada file suara kemenangan
        }

    </script>
</body>
</html>
